name: Create PR to wire-server-deploy

on:
  push:
    branches:
      - offline
      - pin-wire-server-version  # Temporary: for testing
    paths:
      - 'build.json'
  pull_request:
    paths:
      - 'build.json'
  workflow_dispatch:
    inputs:
      wire_server_version:
        description: 'Pin wire-server version (e.g., 5.23.0) or leave empty to skip pinning'
        required: false
        type: string
        default: ''
      pin_charts:
        description: 'Pin individual charts (format: chart:release:repo:github_repo, comma-separated for multiple)'
        required: false
        type: string
        default: ''

jobs:
  create-deploy-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write to push pinning commits

    steps:
      - name: Checkout wire-builds
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pin versions if specified
        id: pin-version
        if: ${{ github.event_name == 'workflow_dispatch' && (inputs.wire_server_version != '' || inputs.pin_charts != '') }}
        run: |
          set -euo pipefail

          # Build command with optional parameters
          CMD=".github/scripts/pin-version.sh --file build.json --base-branch \"${{ github.ref_name }}\""

          # Add wire-server version if specified
          if [ -n "${{ inputs.wire_server_version }}" ]; then
            CMD="$CMD --version \"${{ inputs.wire_server_version }}\""
          fi

          # Add chart pins if specified
          if [ -n "${{ inputs.pin_charts }}" ]; then
            # Split comma-separated list and add each as --pin-chart
            IFS=',' read -ra CHARTS <<< "${{ inputs.pin_charts }}"
            for chart_spec in "${CHARTS[@]}"; do
              # Trim whitespace
              chart_spec=$(echo "$chart_spec" | xargs)
              CMD="$CMD --pin-chart \"$chart_spec\""
            done
          fi

          echo "Running: $CMD"
          TAG_NAME=$(eval "$CMD")
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Pinned tag: $TAG_NAME"

      - name: Get reference for build.json
        id: get-ref
        run: |
          # Use pinned tag if pinning was performed, otherwise use current HEAD
          if [ -n "${{ steps.pin-version.outputs.tag_name }}" ]; then
            BUILD_REF="${{ steps.pin-version.outputs.tag_name }}"
            echo "Using pinned tag: $BUILD_REF"
          else
            BUILD_REF=$(git rev-parse HEAD)
            echo "Using commit SHA: $BUILD_REF"
          fi
          echo "build_ref=$BUILD_REF" >> $GITHUB_OUTPUT

      - name: Checkout wire-server-deploy
        uses: actions/checkout@v4
        with:
          repository: wireapp/wire-server-deploy
          token: ${{ secrets.ZEBOT_TOKEN || secrets.GITHUB_TOKEN }}
          path: wire-server-deploy
          fetch-depth: 0

      - name: Update wire-server-deploy and create PR
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          .github/scripts/update-deploy-pr.sh \
            --ref "${{ steps.get-ref.outputs.build_ref }}" \
            --deploy-dir wire-server-deploy \
            --token "${{ secrets.ZEBOT_TOKEN || secrets.GITHUB_TOKEN }}"

      - name: Summary
        run: |
          echo "âœ… Workflow completed successfully"
          echo "   Build reference: ${{ steps.get-ref.outputs.build_ref }}"
