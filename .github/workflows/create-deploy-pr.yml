name: Create PR to wire-server-deploy

on:
  push:
    branches:
      - offline
      - pin-wire-server-version  # Temporary: for testing
    paths:
      - 'build.json'
  pull_request:
    paths:
      - 'build.json'
  workflow_dispatch:
    inputs:
      wire_server_version:
        description: 'Pin wire-server version'
        required: false
        type: choice
        options:
          - 'none'
          - '5.24.0'
          - '5.23.0'
          - '5.22.0'
          - '5.21.0'
          - '5.20.0'
          - '5.19.0'
          - '5.18.0'
          - '5.17.0'
          - '5.16.0'
          - '5.15.0'
          - '5.14.0'
          - '5.13.0'
          - '5.12.0'
          - '5.11.0'
          - '5.10.0'
          - '5.9.0'
          - '5.8.0'
          - '5.7.0'
          - '5.6.0'
          - '5.5.0'
        default: 'none'

jobs:
  create-deploy-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Need write to push pinning commits

    steps:
      - name: Checkout wire-builds
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pin wire-server version if specified
        id: pin-version
        if: ${{ inputs.wire_server_version != 'none' && inputs.wire_server_version != '' }}
        run: |
          TAG_NAME=$(.github/scripts/pin-version.sh \
            --version "${{ inputs.wire_server_version }}" \
            --file build.json \
            --base-branch "${{ github.ref_name }}" | tail -1)
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Pinned tag: $TAG_NAME"

      - name: Get reference for build.json
        id: get-ref
        run: |
          # Use pinned tag if pinning was performed, otherwise use current HEAD
          if [ -n "${{ steps.pin-version.outputs.tag_name }}" ]; then
            BUILD_REF="${{ steps.pin-version.outputs.tag_name }}"
            echo "Using pinned tag: $BUILD_REF"
          else
            BUILD_REF=$(git rev-parse HEAD)
            echo "Using commit SHA: $BUILD_REF"
          fi
          echo "build_ref=$BUILD_REF" >> $GITHUB_OUTPUT

      - name: Checkout wire-server-deploy
        uses: actions/checkout@v4
        with:
          repository: wireapp/wire-server-deploy
          token: ${{ secrets.ZEBOT_TOKEN || secrets.GITHUB_TOKEN }}
          path: wire-server-deploy
          fetch-depth: 0

      - name: Update wire-server-deploy and create PR
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          .github/scripts/update-deploy-pr.sh \
            --ref "${{ steps.get-ref.outputs.build_ref }}" \
            --deploy-dir wire-server-deploy \
            --token "${{ secrets.ZEBOT_TOKEN || secrets.GITHUB_TOKEN }}"

      - name: Summary
        run: |
          echo "âœ… Workflow completed successfully"
          echo "   Build reference: ${{ steps.get-ref.outputs.build_ref }}"
